<template>
  <div>
    <nav-bar :title="text"></nav-bar>
    <!-- 内容部分 -->
    <video id="qr-vedio" class="v" autoplay></video>
    <canvas
      id="qr-canvas"
      width="800"
      height="600"
      style="width: 800px; height: 600px;display:none;"
    ></canvas>
    <p v-show="result != ''">{{result}}</p>
    <p v-show="errorMes != ''">{{errorMes}}</p>
  </div>
</template>
 
<script>
import qrcode from "qrcode";
import navBar from "com/nav-bar";

export default {
  components: {
    navBar
  },
  data() {
    return {
      text: '扫码',
      vedio: "",
      canvas: "",
      context: "",
      stopScan: null,
      errorMes: "",
      result: ""
    };
  },
  mounted() {
    console.log(1);
    const _that = this;
    window.URL =
      window.URL || window.webkitURL || window.mozURL || window.msURL;
    navigator.getUserMedia =
      navigator.getUserMedia ||
      navigator.webkitGetUserMedia ||
      navigator.mozGetUserMedia ||
      navigator.msGetUserMedia;

    this.vedio = document.getElementById("qr-vedio");
    this.canvas = document.getElementById("qr-canvas");
    this.context = this.canvas.getContext("2d");

    console.log(2);
    // Call the getUserMedia method with our callback functions
    if (navigator.getUserMedia) {
      console.log(3);
      var videoSource = [];
      navigator.mediaDevices.enumerateDevices().then(function(sourceInfos) {
        var i;
        for (i = 0; i != sourceInfos.length; ++i) {
          var sourceInfo = sourceInfos[i];
          if (
            sourceInfo.kind === "videoinput" &&
            sourceInfo.label.indexOf("back") != -1
          ) {
            videoSource.push(sourceInfo.deviceId);
          }
        }
        var successCallback = function(stream) {
          _that.vedio.src =
            (window.URL && window.URL.createObjectURL(stream)) || stream;
          window.localMediaStream = stream;
          _that.vedio.addEventListener(
            "loadstart",
            function() {
              _that.vedio.play();
            },
            false
          );
          _that.stopScan = setInterval(_that.scan, 500);
        };

        navigator.getUserMedia(
          {
            video: {
              optional: [{ sourceId: videoSource[0] }]
            }
          },
          successCallback,
          function(e) {
            console.log(e);
          }
        );
      });
    } else {
      this.errorMes = "此浏览器不支持本机网络摄像机流";
    }

    qrcode.callback = function(data) {
      _that.result = data;
      console.log(data);
      if (window.localMediaStream && window.localMediaStream.stop) {
        window.localMediaStream.stop();
      }
      if (_that.stopScan) {
        clearInterval(_that.stopScan);
      }
    };
  },
  methods: {
    scan() {
      if (window.localMediaStream) {
        this.context.drawImage(this.vedio, 0, 0, 100, 100);
      }
      try {
        qrcode.decode();
      } catch (e) {
        console.log("decode has error");
      }
    }
  }
};
</script>
 
<style lang="scss" scoped>
.v {
  width: 320px;
  height: 240px;
}
p{
  padding: 30px;
  color: #666;
}

#qr-canvas {
  width: 800px;
  height: 800px;
}
</style>